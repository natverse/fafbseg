<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Mesh to mesh distances • fafbseg</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Mesh to mesh distances">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fafbseg</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.15.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/accessing-graphene-server.html">Accessing the chunked graph server</a></li>
    <li><a class="dropdown-item" href="../articles/capturing-ngl-meshes.html">Capturing neuroglancer meshes from a browser scene</a></li>
    <li><a class="dropdown-item" href="../articles/FAFB-FlyWire.html">FAFB-FlyWire</a></li>
    <li><a class="dropdown-item" href="../articles/fafbseg-catmaid-legacy-info.html">fafbseg-catmaid-legacy-info</a></li>
    <li><a class="dropdown-item" href="../articles/installing-cloudvolume-meshparty.html">Installing python modules: cloudvolume, meshparty and skeletor</a></li>
    <li><a class="dropdown-item" href="../articles/mesh-to-mesh.html">Mesh to mesh distances</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="nav-link" href="../SUPPORT.html">Help</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://natverse.org/">natverse</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/natverse/fafbseg"><span class="fa fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Mesh to mesh distances</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/natverse/fafbseg/blob/master/vignettes/articles/mesh-to-mesh.Rmd" class="external-link"><code>vignettes/articles/mesh-to-mesh.Rmd</code></a></small>
      <div class="d-none name"><code>mesh-to-mesh.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="note">Note<a class="anchor" aria-label="anchor" href="#note"></a>
</h2>
<p>This is an <a href="http://rmarkdown.rstudio.com" class="external-link">R Markdown</a>
Notebook. When you execute code within the notebook, the results appear
beneath the code.</p>
<p>Try executing this chunk by clicking the <em>Run</em> button within
the chunk or by placing your cursor inside it and pressing
<em>Cmd+Shift+Enter</em>.</p>
</div>
<div class="section level2">
<h2 id="find-the-distance-between-meshes">Find the distance between meshes<a class="anchor" aria-label="anchor" href="#find-the-distance-between-meshes"></a>
</h2>
<p>There are two ways that I can immediately think of addressing
this</p>
<ol style="list-style-type: decimal">
<li>Find the distance of every vertex on mesh 1 to its nearest neighbour
on mesh 2</li>
<li>Find the (signed) distance from every vertex of mesh 1 to the
surface of mesh 2</li>
</ol>
<p>Obviously the ideal situation would be to find the mesh to mesh
distances for the two objects (or even do a Euclidean distance transform
on the voxel representation of the objects.) but neither of those are so
accessible.</p>
<p>Option 1 is probably still a perfectly good option for most purposes
since the meshes are quite densely sampled (i.e. the vertices are close
together).</p>
</div>
<div class="section level2">
<h2 id="setup-and-mesh-volume">Setup and Mesh volume<a class="anchor" aria-label="anchor" href="#setup-and-mesh-volume"></a>
</h2>
<p>Let’s use the same example that I mentioned on FlyWire slack.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/natverse/fafbseg" class="external-link">fafbseg</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: nat</span></span></code></pre>
<pre><code><span><span class="co">## Loading required package: rgl</span></span></code></pre>
<pre><code><span><span class="co">## Registered S3 method overwritten by 'nat':</span></span>
<span><span class="co">##   method             from</span></span>
<span><span class="co">##   as.mesh3d.ashape3d rgl</span></span></code></pre>
<pre><code><span><span class="co">## Some nat functions depend on a CMTK installation. See ?cmtk and README.md for details.</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'nat'</span></span></code></pre>
<pre><code><span><span class="co">## The following object is masked from 'package:rgl':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     wire3d</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:base':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     intersect, setdiff, union</span></span></code></pre>
<pre><code><span><span class="co">## Run dr_fafbseg() for a status report on your installation</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/choose_segmentation.html">choose_segmentation</a></span><span class="op">(</span><span class="st">"flywire31"</span><span class="op">)</span></span>
<span><span class="va">va6pn</span><span class="op">=</span><span class="fu"><a href="../reference/read_cloudvolume_meshes.html">read_cloudvolume_meshes</a></span><span class="op">(</span><span class="st">"720575940633169983"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   downloading meshes</span></span></code></pre>
<pre><code><span><span class="co">##   parsing downloaded meshes</span></span></code></pre>
<p>There we were asked to find the volume of a mesh. The first attempt
fails</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">Rvcg</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Rvcg/man/vcgVolume.html" class="external-link">vcgVolume</a></span><span class="op">(</span><span class="va">va6pn</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>So we need to clean up the mesh:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">va6pn.clean</span><span class="op">=</span><span class="fu">Rvcg</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Rvcg/man/vcgClean.html" class="external-link">vcgClean</a></span><span class="op">(</span><span class="va">va6pn</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, sel<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">6</span>, iterate <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## removed 68 duplicate faces and 0 duplicate vertices</span></span>
<span><span class="co">## removed 0 unreferenced vertices</span></span>
<span><span class="co">## removed 34 Non-manifold faces</span></span>
<span><span class="co">## removed 0 degenerate faces</span></span>
<span><span class="co">## removed 16 Non-manifold vertices</span></span>
<span><span class="co">## split 3 non-manifold vertices</span></span>
<span><span class="co">## merged 0 close vertices</span></span>
<span><span class="co">## removed 0 duplicate faces and 0 duplicate vertices</span></span>
<span><span class="co">## removed 3 unreferenced vertices</span></span>
<span><span class="co">## removed 0 Non-manifold faces</span></span>
<span><span class="co">## removed 0 degenerate faces</span></span>
<span><span class="co">## removed 3 Non-manifold vertices</span></span>
<span><span class="co">## split 0 non-manifold vertices</span></span>
<span><span class="co">## merged 0 close vertices</span></span>
<span><span class="co">## removed 0 duplicate faces and 0 duplicate vertices</span></span>
<span><span class="co">## removed 0 unreferenced vertices</span></span>
<span><span class="co">## removed 0 Non-manifold faces</span></span>
<span><span class="co">## removed 0 degenerate faces</span></span>
<span><span class="co">## removed 0 Non-manifold vertices</span></span>
<span><span class="co">## split 0 non-manifold vertices</span></span>
<span><span class="co">## merged 0 close vertices</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vol</span><span class="op">=</span><span class="fu">Rvcg</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Rvcg/man/vcgVolume.html" class="external-link">vcgVolume</a></span><span class="op">(</span><span class="va">va6pn.clean</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in Rvcg::vcgVolume(va6pn.clean): Mesh is not watertight! USE RESULT</span></span>
<span><span class="co">## WITH CARE!</span></span></code></pre>
<pre><code><span><span class="co">## Warning in Rvcg::vcgVolume(va6pn.clean): Mesh is not coherently oriented! USE</span></span>
<span><span class="co">## RESULT WITH CARE!</span></span></code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vol</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2.506317e+12</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># cubic microns </span></span>
<span><span class="va">vol</span><span class="op">/</span><span class="fl">1e9</span> </span></code></pre></div>
<pre><code><span><span class="co">## [1] 2506.317</span></span></code></pre>
<div class="section level3">
<h3 id="compare-with-neurons-skeleton-available-from-vfb-catmaid">Compare with neuron’s skeleton available from VFB catmaid<a class="anchor" aria-label="anchor" href="#compare-with-neurons-skeleton-available-from-vfb-catmaid"></a>
</h3>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/natverse/elmr" class="external-link">elmr</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: catmaid</span></span></code></pre>
<pre><code><span><span class="co">## Loading required package: httr</span></span></code></pre>
<pre><code><span><span class="co">## Loading required package: nat.flybrains</span></span></code></pre>
<pre><code><span><span class="co">## Loading required package: nat.templatebrains</span></span></code></pre>
<pre><code><span><span class="co">## Loading required package: nat.nblast</span></span></code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fafbconn</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/catmaid/man/vfbcatmaid.html" class="external-link">vfbcatmaid</a></span><span class="op">(</span><span class="st">"fafb"</span><span class="op">)</span></span>
<span><span class="va">va6pn.skel</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/catmaid/man/read.neuron.catmaid.html" class="external-link">read.neurons.catmaid</a></span><span class="op">(</span><span class="st">"name:VA6.*PN"</span>, conn<span class="op">=</span><span class="va">fafbconn</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">va6pn.skel</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       root nodes segments branchpoints endpoints cable.length nTrees connectors</span></span>
<span><span class="co">## 16   11222 16840     2402         1172      1231      4003108      1       2158</span></span>
<span><span class="co">## 3133  1255 19832     2974         1461      1514      4800908      1       1026</span></span>
<span><span class="co">##      nsoma</span></span>
<span><span class="co">## 16       1</span></span>
<span><span class="co">## 3133     1</span></span></code></pre>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cable.length</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">va6pn.skel</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="st">"cable.length"</span><span class="op">]</span></span>
<span><span class="va">vol</span><span class="op">/</span><span class="va">cable.length</span> <span class="co"># in nm</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 626092.8</span></span></code></pre>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vol</span><span class="op">/</span><span class="va">cable.length</span><span class="op">/</span><span class="fl">1e6</span> <span class="co"># in µm</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.6260928</span></span></code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A</span><span class="op">=</span><span class="va">vol</span><span class="op">/</span><span class="va">cable.length</span><span class="op">/</span><span class="fl">1e6</span> <span class="co"># mean area µm2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">A</span><span class="op">/</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">pi</span><span class="op">)</span><span class="op">)</span> <span class="co"># implied radius µm, seems reasonable</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.3156672</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="option-1-vertex-to-vertex-distance">Option 1: Vertex to vertex distance<a class="anchor" aria-label="anchor" href="#option-1-vertex-to-vertex-distance"></a>
</h2>
<p>So let’s try and find the vertex to vertex distance for a pair of
neurons. We happen to know that this lateral horn local interneuron is a
target of the VA6 PN.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pv4b4</span><span class="op">=</span><span class="fu"><a href="../reference/read_cloudvolume_meshes.html">read_cloudvolume_meshes</a></span><span class="op">(</span><span class="st">'720575940619630430'</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   downloading meshes</span></span></code></pre>
<pre><code><span><span class="co">##   parsing downloaded meshes</span></span></code></pre>
<p>Now we can use a <a href="https://en.wikipedia.org/wiki/K-d_tree" class="external-link">k-d
tree</a> to find the nearest neighbour distances very efficiently. Note
also the use of the <a href="http://natverse.org/nat/reference/xyzmatrix.html" class="external-link"><code>xyzmatrix</code></a>
function to extract vertex locations - this works for all objects that
the natverse knows about.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># better to make the tree from the larger object </span></span>
<span><span class="co"># and query using points from the smaller object</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/nat/man/nvertices.html" class="external-link">nvertices</a></span><span class="op">(</span><span class="va">pv4b4</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 720575940619630430 </span></span>
<span><span class="co">##             101419</span></span></code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/nat/man/nvertices.html" class="external-link">nvertices</a></span><span class="op">(</span><span class="va">va6pn</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 720575940633169983 </span></span>
<span><span class="co">##             877023</span></span></code></pre>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kd</span><span class="op">=</span><span class="fu">nabor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/nabor/man/knn.html" class="external-link">knn</a></span><span class="op">(</span>query <span class="op">=</span> <span class="fu"><a href="../reference/xyzmatrix.html">xyzmatrix</a></span><span class="op">(</span><span class="va">pv4b4</span><span class="op">)</span>, data<span class="op">=</span><span class="fu"><a href="../reference/xyzmatrix.html">xyzmatrix</a></span><span class="op">(</span><span class="va">va6pn</span><span class="op">)</span>, k<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">kd</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## List of 2</span></span>
<span><span class="co">##  $ nn.idx  : int [1:101419, 1] 4041 4041 4041 4041 4041 4041 4041 4041 4041 4041 ...</span></span>
<span><span class="co">##  $ nn.dists: num [1:101419, 1] 30734 30613 30251 30724 30213 ...</span></span></code></pre>
<p>This gives us:</p>
<ol style="list-style-type: decimal">
<li>a set of vertex indices for the closest match on the VA6 PN for
every vertex on the LHLN</li>
<li>the distances to those matching vertices</li>
</ol>
<p>We can take a look at the distribution of the distances like so:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span>, br<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesh-to-mesh_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>You can see that there are actually quite a lot of close
distances.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span>, br<span class="op">=</span><span class="fl">500</span>, xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2000</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesh-to-mesh_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>and I assume that the excess of distances &lt;1000 nm where there is
a little dip in the distribution is related to this being a pair of
neurons that are actually synaptically connected.</p>
<div class="section level3">
<h3 id="locations-of-closest-approach">Locations of closest approach<a class="anchor" aria-label="anchor" href="#locations-of-closest-approach"></a>
</h3>
<p>OK. So where do those meshes actually approach each other. Well we
could look at the locations of the very closest distances &lt;100 nm.
How many are there?</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span><span class="op">&lt;</span><span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1508</span></span></code></pre>
<p>Still a lot! This is because at a location of close approach between
the neurons, there will be multiple vertices that are very close
together. Separating out these distinct contact locations is a more
complex problem than simply calculating all of these vertex distances.
The first thing we could do is throw out cases where the same vertex on
the target neuron is a match.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.idx</span><span class="op">[</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span><span class="op">&lt;</span><span class="fl">100</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1017</span></span></code></pre>
<p>Looks like that would reduce by a third.</p>
</div>
<div class="section level3">
<h3 id="visualising-contacts">Visualising contacts<a class="anchor" aria-label="anchor" href="#visualising-contacts"></a>
</h3>
<p>Let’s just take a quick detour and see what the close approaches look
like:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rgl</span><span class="fu">::</span><span class="fu"><a href="https://dmurdoch.github.io/rgl/dev/reference/setupKnitr.html" class="external-link">setupKnitr</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/nat/man/nopen3d.html" class="external-link">nopen3d</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dmurdoch.github.io/rgl/dev/reference/plot3d.html" class="external-link">plot3d</a></span><span class="op">(</span><span class="va">pv4b4</span>, type<span class="op">=</span><span class="st">'wire'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dmurdoch.github.io/rgl/dev/reference/plot3d.html" class="external-link">plot3d</a></span><span class="op">(</span><span class="va">va6pn</span>, col<span class="op">=</span><span class="st">'red'</span>, type<span class="op">=</span><span class="st">'wire'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dmurdoch.github.io/rgl/dev/reference/spheres.html" class="external-link">spheres3d</a></span><span class="op">(</span><span class="fu"><a href="../reference/xyzmatrix.html">xyzmatrix</a></span><span class="op">(</span><span class="va">pv4b4</span><span class="op">)</span><span class="op">[</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span><span class="op">&lt;</span><span class="fl">100</span>,<span class="op">]</span>, col<span class="op">=</span><span class="st">'green'</span>, r<span class="op">=</span><span class="fl">500</span><span class="op">)</span></span></code></pre></div>
<p>Show close nodes on the query mesh</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/nat/man/nclear3d.html" class="external-link">nclear3d</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dmurdoch.github.io/rgl/dev/reference/plot3d.html" class="external-link">plot3d</a></span><span class="op">(</span><span class="va">pv4b4</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span><span class="op">&lt;</span><span class="fl">100</span>, <span class="st">'red'</span>, <span class="st">'black'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dmurdoch.github.io/rgl/dev/reference/plot3d.html" class="external-link">plot3d</a></span><span class="op">(</span><span class="va">va6pn</span>, col<span class="op">=</span><span class="st">'grey'</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="mesh-to-mesh_insertimage_3.png" alt="LHLN + PN"><div class="figcaption">LHLN + PN</div>
</div>
<p>Just the query mesh</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/nat/man/nclear3d.html" class="external-link">nclear3d</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dmurdoch.github.io/rgl/dev/reference/plot3d.html" class="external-link">plot3d</a></span><span class="op">(</span><span class="va">pv4b4</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span><span class="op">&lt;</span><span class="fl">100</span>, <span class="st">'red'</span>, <span class="st">'black'</span><span class="op">)</span>, type<span class="op">=</span><span class="st">'wire'</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="mesh-to-mesh_insertimage_1.png" alt="LHLN with close contact areas in red"><div class="figcaption">LHLN with close contact areas in red</div>
</div>
</div>
<div class="section level3">
<h3 id="identifying-discrete-contact-zones">Identifying discrete contact zones<a class="anchor" aria-label="anchor" href="#identifying-discrete-contact-zones"></a>
</h3>
<p>There are a range of ways this could be done, essentially what we
have is a number of local minima in the distance field to find. It might
also be the case that one “patch” on one neuron actually matches several
patches on the other neuron. However we’ll just try to pick a simpler
approach as an example.</p>
<p>Let’s take the points below threshold distance on the query neuron
and find the geodesic distance (i.e. the distance along the mesh
surface) between them.</p>
<p>We need to do a bit of prep work for this, to make a graph
representation of the mesh.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Make an igraph representation of the edge network of a mesh object</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param x A \code{mesh3d} object or an object for which an \code{as.mesh3d}</span></span>
<span><span class="co">#'   method is defined. As a convenience the first mesh object is extracted when</span></span>
<span><span class="co">#'   \code{x} is a \code{shapelist3d} object.</span></span>
<span><span class="co">#' @param ... additional arguments passed to \code{as.mesh3d}</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return a \code{igraph} object whose vertices correspond to the vertices of the</span></span>
<span><span class="co">#'   original mesh object and whose edges have weights matching the edge lengths</span></span>
<span><span class="co">#'   in the mesh.</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">mesh2graph</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">'shapelist3d'</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span><span class="op">=</span><span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">'neuronlist'</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span><span class="op">=</span><span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">'mesh3d'</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span><span class="op">=</span><span class="fu"><a href="https://dmurdoch.github.io/rgl/dev/reference/as.mesh3d.default.html" class="external-link">as.mesh3d</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">it</span><span class="op">)</span><span class="op">!=</span><span class="fl">3</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"I only work for triangulat meshes right now"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># make the edge list</span></span>
<span>  <span class="va">v1</span><span class="op">=</span><span class="va">x</span><span class="op">$</span><span class="va">it</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span></span>
<span>  <span class="va">v2</span><span class="op">=</span><span class="va">x</span><span class="op">$</span><span class="va">it</span><span class="op">[</span><span class="fl">2</span>,<span class="op">]</span></span>
<span>  <span class="va">v3</span><span class="op">=</span><span class="va">x</span><span class="op">$</span><span class="va">it</span><span class="op">[</span><span class="fl">3</span>,<span class="op">]</span></span>
<span>  <span class="va">el</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">v1</span>,<span class="va">v2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">v1</span>,<span class="va">v3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">v2</span>,<span class="va">v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">g</span><span class="op">=</span><span class="fu">igraph</span><span class="fu">::</span><span class="fu"><a href="https://r.igraph.org/reference/graph_from_edgelist.html" class="external-link">graph_from_edgelist</a></span><span class="op">(</span><span class="va">el</span>, directed <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># calculate lengths of each edge</span></span>
<span>  <span class="va">xyz</span><span class="op">=</span><span class="fu"><a href="../reference/xyzmatrix.html">xyzmatrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">edgelengths</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">v1</span>, <span class="va">v2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">deltas</span><span class="op">=</span><span class="va">xyz</span><span class="op">[</span><span class="va">v1</span>,,drop<span class="op">=</span><span class="cn">F</span><span class="op">]</span><span class="op">-</span><span class="va">xyz</span><span class="op">[</span><span class="va">v2</span>,,drop<span class="op">=</span><span class="cn">F</span><span class="op">]</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">deltas</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">weights</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">edgelengths</span><span class="op">(</span><span class="va">v1</span>,<span class="va">v2</span><span class="op">)</span>, <span class="fu">edgelengths</span><span class="op">(</span><span class="va">v1</span>,<span class="va">v3</span><span class="op">)</span>, <span class="fu">edgelengths</span><span class="op">(</span><span class="va">v2</span>,<span class="va">v3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">igraph</span><span class="fu">::</span><span class="fu"><a href="https://r.igraph.org/reference/E.html" class="external-link">E</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span><span class="op">$</span><span class="va">weight</span><span class="op">=</span><span class="va">weights</span></span>
<span>  <span class="va">g</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Convert the LHLN to this mesh representation</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g</span><span class="op">=</span><span class="fu">mesh2graph</span><span class="op">(</span><span class="va">pv4b4</span><span class="op">)</span></span></code></pre></div>
<p>Now we can find the geodesic distance between all selected nodes.</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dmat</span><span class="op">=</span><span class="fu">igraph</span><span class="fu">::</span><span class="fu"><a href="https://r.igraph.org/reference/distances.html" class="external-link">distances</a></span><span class="op">(</span><span class="va">g</span>, v<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span><span class="op">&lt;</span><span class="fl">100</span><span class="op">)</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span><span class="op">&lt;</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Let’s try clustering that distance matrix</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dd</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/hclust.html" class="external-link">hclust</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">as.dist</a></span><span class="op">(</span><span class="va">dmat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dd</span>, labels <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesh-to-mesh_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># cut using a height relating to a separation of 3000nm</span></span>
<span><span class="va">groups</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/cutree.html" class="external-link">cutree</a></span><span class="op">(</span><span class="va">dd</span>, h<span class="op">=</span><span class="fl">3000</span><span class="op">)</span></span>
<span><span class="co"># sample randomises colours so that neighbouring clusters have different colours</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">groupcols</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">rainbow</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">groups</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="va">groups</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/nat/man/nclear3d.html" class="external-link">nclear3d</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dmurdoch.github.io/rgl/dev/reference/spheres.html" class="external-link">spheres3d</a></span><span class="op">(</span><span class="fu"><a href="../reference/xyzmatrix.html">xyzmatrix</a></span><span class="op">(</span><span class="va">pv4b4</span><span class="op">)</span><span class="op">[</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span><span class="op">&lt;</span><span class="fl">100</span>,<span class="op">]</span>, col<span class="op">=</span><span class="va">groupcols</span>, rad<span class="op">=</span><span class="fl">200</span><span class="op">)</span></span>
<span><span class="fu">wire3d</span><span class="op">(</span><span class="va">pv4b4</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">kd</span><span class="op">$</span><span class="va">nn.dists</span><span class="op">&lt;</span><span class="fl">100</span>, <span class="st">'red'</span>, <span class="st">'black'</span><span class="op">)</span>, type<span class="op">=</span><span class="st">'wire'</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesh-to-mesh_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
<div class="float">
<img src="mesh-to-mesh_insertimage_2.png" alt="Close contacts in different colours"><div class="figcaption">Close contacts in different colours</div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Gregory Jefferis.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
