<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Convert 3D x,y,z locations in brainmaps volumes to segmentation ids — brainmaps_xyz2id • fafbseg</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Convert 3D x,y,z locations in brainmaps volumes to segmentation ids — brainmaps_xyz2id" />
<meta property="og:description" content="Convert 3D x,y,z locations in brainmaps volumes to segmentation ids" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fafbseg</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.7.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/articles/FAFB-FlyWire.html">FAFB-FlyWire</a>
    </li>
    <li>
      <a href="../articles/articles/capturing-ngl-meshes.html">Capturing neuroglancer meshes from a browser scene</a>
    </li>
    <li>
      <a href="../articles/articles/mesh-to-mesh.html">Mesh to mesh distances</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
<li>
  <a href="../SUPPORT.html">Help</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://natverse.github.io">natverse</a>
</li>
<li>
  <a href="https://github.com/natverse/fafbseg">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Convert 3D x,y,z locations in brainmaps volumes to segmentation ids</h1>
    <small class="dont-index">Source: <a href='https://github.com/natverse/fafbseg/blob/master/R/brainmaps-api.R'><code>R/brainmaps-api.R</code></a></small>
    <div class="hidden name"><code>brainmaps_xyz2id.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Convert 3D x,y,z locations in brainmaps volumes to segmentation ids</p>
    </div>

    <pre class="usage"><span class='fu'>brainmaps_xyz2id</span>(
  <span class='no'>xyz</span>,
  <span class='kw'>volume</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/options.html'>getOption</a></span>(<span class='st'>"fafbseg.skeletonuri"</span>),
  <span class='kw'>rawcoords</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>,
  <span class='kw'>rawvoxdims</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='fl'>8</span>, <span class='fl'>8</span>, <span class='fl'>40</span>),
  <span class='kw'>chunksize</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/options.html'>getOption</a></span>(<span class='st'>"fafbseg.brainmaps_xyz2id.chunksize"</span>, <span class='fl'>200</span>),
  <span class='no'>...</span>
)</pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>xyz</th>
      <td><p>N x 3 matrix of points or an object containing vertex data that is
compatible with <code><a href='xyzmatrix.html'>xyzmatrix</a></code>. These should be in physical space
(i.e. nm) unless <code>voxdims=NULL</code>.</p></td>
    </tr>
    <tr>
      <th>volume</th>
      <td><p>character vector identifier string for the volume containing
segmentation data - by default it uses the value of the
<code>fafbseg.skeletonuri</code> option. Any input that can be parsed by
<code><a href='brainmaps_volume.html'>brainmaps_volume</a></code> is acceptable.</p></td>
    </tr>
    <tr>
      <th>rawcoords</th>
      <td><p>Whether the coordinates are voxel indices (when
<code>rawcoords=TRUE</code>) or physical units (nm, the default).</p></td>
    </tr>
    <tr>
      <th>rawvoxdims</th>
      <td><p>the implied voxel dimensions for the volume. If
<code>rawcoords=TRUE</code> then this will be used to convert the raw coordinates
into physical units. The default value matches the normal voxel size in
neuroglancer. If <code>rawvoxdims=NULL</code> then no attempt is made to scale
the coordinates whatsoever. See details.</p></td>
    </tr>
    <tr>
      <th>chunksize</th>
      <td><p>send queries in batches each of which has at most
<code>chunksize</code> points. The default is chosen since the brainmaps API can
time out if the points take too long to map (more likely if they are spread
out across the brain). There is also a maximum number of points per call
(10,000 was the recommended upper limit at one point).</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>Additional arguments passed to <code><a href='brainmaps_fetch.html'>brainmaps_fetch</a></code>. This
can include setting the <code>retry</code> argument to &gt;0. See <b>Details</b> and
<b>Examples</b>.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A numeric vector of Google segment ids</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>The underlying <code>brainmaps</code> API expects raw coordinates i.e.
  voxel indices. This is slightly complicated by the fact that different
  segmentation, skeleton etc volumes may have different associated voxel
  dimensions. <code>brainmaps_xyz2id</code> automatically looks up this voxel
  dimension.</p>
<p>However it may be that you want to pass in raw coordinates from
  neuroglancer. These will generally be associated with a the resolution of
  the image data not e.g. skeletons which may have a larger (coarser) voxel
  size. As a convenience in this situation you can set <code>rawcoords=TRUE</code>.</p>
<p>If you have problems with requests failing sporadically, it may be helpful
  to know</p><ul>
<li><p>Google does not keep the underlying data live so there may be some
  spin-up time.</p></li>
<li><p>there is an arbitrary timeout at the Google end (currently ~ 5s)</p></li>
<li><p>batching nearby points helps</p></li>
</ul>

<p>Using the <code>chunksize</code> argument or the <code>retry</code> argument passed on
  to <code><a href='brainmaps_fetch.html'>brainmaps_fetch</a></code> can overcome these issues. See the
  examples.</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='kw'>if</span> (<span class='fl'>FALSE</span>) {
<span class='co'># Physical location in nm</span>
<span class='fu'>brainmaps_xyz2id</span>(<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='fl'>433368</span>, <span class='fl'>168208</span>, <span class='fl'>128480</span>))
<span class='co'># Same location as displayed in neuroglancer</span>
<span class='fu'>brainmaps_xyz2id</span>(<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='fl'>54171</span>, <span class='fl'>21026</span>, <span class='fl'>3212</span>), <span class='kw'>rawcoords</span><span class='kw'>=</span><span class='fl'>TRUE</span>)

<span class='co'># Raw coodinates for the brainmaps volume in question - don't touch</span>
<span class='fu'>brainmaps_xyz2id</span>(<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='fl'>433368</span>, <span class='fl'>168208</span>, <span class='fl'>128480</span>)/<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='fl'>32</span>,<span class='fl'>32</span>,<span class='fl'>40</span>), <span class='kw'>rawvoxdims</span><span class='kw'>=</span><span class='kw'>NULL</span>)

<span class='fu'><a href='https://rdrr.io/r/base/library.html'>library</a></span>(<span class='no'>elmr</span>)
<span class='co'># get a manually traced neuron (just keep first and only entry in neuronlist)</span>
<span class='no'>dl4</span><span class='kw'>=</span><span class='fu'>read.neurons.catmaid</span>(<span class='st'>'glomerulus DL4 right'</span>)<span class='kw'>[[</span><span class='fl'>1</span>]]
<span class='co'># map every node location to segmentation ids</span>
<span class='no'>dl4.segs</span><span class='kw'>=</span><span class='fu'>brainmaps_xyz2id</span>(<span class='no'>dl4</span>)
<span class='co'># remove unmapped locations which get id 0</span>
<span class='no'>dl4.segs</span><span class='kw'>=</span><span class='fu'><a href='https://rdrr.io/r/base/sets.html'>setdiff</a></span>(<span class='no'>dl4.segs</span>, <span class='fl'>0</span>)
<span class='co'># read in corresponding skeletons</span>
<span class='no'>dl4.skels</span><span class='kw'>=</span><span class='fu'><a href='read_segments.html'>read_segments2</a></span>(<span class='no'>dl4.segs</span>)
<span class='co'># read in corresponding skeletons after including agglomeration merge groups</span>
<span class='no'>dl4.allskels</span><span class='kw'>=</span><span class='fu'><a href='read_segments.html'>read_segments2</a></span>(<span class='fu'><a href='find_merged_segments.html'>find_merged_segments</a></span>(<span class='no'>dl4.segs</span>))

<span class='co'>## retries / cache / chunksize issues</span>
<span class='co'># set small chunk size</span>
<span class='no'>dl4.segs</span><span class='kw'>=</span><span class='fu'>brainmaps_xyz2id</span>(<span class='no'>dl4</span>, <span class='kw'>chunksize</span><span class='kw'>=</span><span class='fl'>500</span>)
<span class='co'># use retries in case of failure</span>
<span class='no'>dl4.segs</span><span class='kw'>=</span><span class='fu'>brainmaps_xyz2id</span>(<span class='no'>dl4</span>, <span class='kw'>chunksize</span><span class='kw'>=</span><span class='fl'>500</span>, <span class='kw'>retry</span><span class='kw'>=</span><span class='fl'>3</span>)
<span class='co'># cache successful requests (if you might need to repeat)</span>
<span class='no'>dl4.segs</span><span class='kw'>=</span><span class='fu'>brainmaps_xyz2id</span>(<span class='no'>dl4</span>, <span class='kw'>chunksize</span><span class='kw'>=</span><span class='fl'>500</span>, <span class='kw'>retry</span><span class='kw'>=</span><span class='fl'>3</span>, <span class='kw'>cache</span><span class='kw'>=</span><span class='fl'>TRUE</span>)
}</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Gregory Jefferis.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


