<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Convert 3D x,y,z locations in brainmaps volumes to segmentation ids — brainmaps_xyz2id • fafbseg</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Convert 3D x,y,z locations in brainmaps volumes to segmentation ids — brainmaps_xyz2id"><meta name="description" content="Convert 3D x,y,z locations in brainmaps volumes to segmentation ids"><meta property="og:description" content="Convert 3D x,y,z locations in brainmaps volumes to segmentation ids"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fafbseg</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.15.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home fa-lg"></span></a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/accessing-graphene-server.html">Accessing the chunked graph server</a></li>
    <li><a class="dropdown-item" href="../articles/capturing-ngl-meshes.html">Capturing neuroglancer meshes from a browser scene</a></li>
    <li><a class="dropdown-item" href="../articles/FAFB-FlyWire.html">FAFB-FlyWire</a></li>
    <li><a class="dropdown-item" href="../articles/fafbseg-catmaid-legacy-info.html">fafbseg-catmaid-legacy-info</a></li>
    <li><a class="dropdown-item" href="../articles/installing-cloudvolume-meshparty.html">Installing python modules: cloudvolume, meshparty and skeletor</a></li>
    <li><a class="dropdown-item" href="../articles/mesh-to-mesh.html">Mesh to mesh distances</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="nav-link" href="../SUPPORT.html">Help</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><a class="external-link nav-link" href="https://natverse.org/">natverse</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/natverse/fafbseg"><span class="fa fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Convert 3D x,y,z locations in brainmaps volumes to segmentation ids</h1>
      <small class="dont-index">Source: <a href="https://github.com/natverse/fafbseg/blob/master/R/brainmaps-api.R" class="external-link"><code>R/brainmaps-api.R</code></a></small>
      <div class="d-none name"><code>brainmaps_xyz2id.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Convert 3D x,y,z locations in brainmaps volumes to segmentation ids</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">brainmaps_xyz2id</span><span class="op">(</span></span>
<span>  <span class="va">xyz</span>,</span>
<span>  volume <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"fafbseg.skeletonuri"</span><span class="op">)</span>,</span>
<span>  rawcoords <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  rawvoxdims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">8</span>, <span class="fl">40</span><span class="op">)</span>,</span>
<span>  chunksize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"fafbseg.brainmaps_xyz2id.chunksize"</span>, <span class="fl">200</span><span class="op">)</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-xyz">xyz<a class="anchor" aria-label="anchor" href="#arg-xyz"></a></dt>
<dd><p>N x 3 matrix of points or an object containing vertex data that is
compatible with <code><a href="xyzmatrix.html">xyzmatrix</a></code>. These should be in physical space
(i.e. nm) unless <code>voxdims=NULL</code>.</p></dd>


<dt id="arg-volume">volume<a class="anchor" aria-label="anchor" href="#arg-volume"></a></dt>
<dd><p>character vector identifier string for the volume containing
segmentation data - by default it uses the value of the
<code>fafbseg.skeletonuri</code> option. Any input that can be parsed by
<code><a href="brainmaps_volume.html">brainmaps_volume</a></code> is acceptable.</p></dd>


<dt id="arg-rawcoords">rawcoords<a class="anchor" aria-label="anchor" href="#arg-rawcoords"></a></dt>
<dd><p>Whether the coordinates are voxel indices (when
<code>rawcoords=TRUE</code>) or physical units (nm, the default).</p></dd>


<dt id="arg-rawvoxdims">rawvoxdims<a class="anchor" aria-label="anchor" href="#arg-rawvoxdims"></a></dt>
<dd><p>the implied voxel dimensions for the volume. If
<code>rawcoords=TRUE</code> then this will be used to convert the raw coordinates
into physical units. The default value matches the normal voxel size in
neuroglancer. If <code>rawvoxdims=NULL</code> then no attempt is made to scale
the coordinates whatsoever. See details.</p></dd>


<dt id="arg-chunksize">chunksize<a class="anchor" aria-label="anchor" href="#arg-chunksize"></a></dt>
<dd><p>send queries in batches each of which has at most
<code>chunksize</code> points. The default is chosen since the brainmaps API can
time out if the points take too long to map (more likely if they are spread
out across the brain). There is also a maximum number of points per call
(10,000 was the recommended upper limit at one point).</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Additional arguments passed to <code><a href="brainmaps_fetch.html">brainmaps_fetch</a></code>. This
can include setting the <code>retry</code> argument to &gt;0. See <b>Details</b> and
<b>Examples</b>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A numeric vector of Google segment ids</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The underlying <code>brainmaps</code> API expects raw coordinates i.e.
  voxel indices. This is slightly complicated by the fact that different
  segmentation, skeleton etc volumes may have different associated voxel
  dimensions. <code>brainmaps_xyz2id</code> automatically looks up this voxel
  dimension.</p>
<p>However it may be that you want to pass in raw coordinates from
  neuroglancer. These will generally be associated with a the resolution of
  the image data not e.g. skeletons which may have a larger (coarser) voxel
  size. As a convenience in this situation you can set <code>rawcoords=TRUE</code>.</p>
<p>If you have problems with requests failing sporadically, it may be helpful
  to know</p><ul><li><p>Google does not keep the underlying data live so there may be some
  spin-up time.</p></li>
<li><p>there is an arbitrary timeout at the Google end (currently ~ 5s)</p></li>
<li><p>batching nearby points helps</p></li>
</ul><p>Using the <code>chunksize</code> argument or the <code>retry</code> argument passed on
  to <code><a href="brainmaps_fetch.html">brainmaps_fetch</a></code> can overcome these issues. See the
  examples.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># Physical location in nm</span></span></span>
<span class="r-in"><span><span class="fu">brainmaps_xyz2id</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">433368</span>, <span class="fl">168208</span>, <span class="fl">128480</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Same location as displayed in neuroglancer</span></span></span>
<span class="r-in"><span><span class="fu">brainmaps_xyz2id</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">54171</span>, <span class="fl">21026</span>, <span class="fl">3212</span><span class="op">)</span>, rawcoords<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Raw coodinates for the brainmaps volume in question - don't touch</span></span></span>
<span class="r-in"><span><span class="fu">brainmaps_xyz2id</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">433368</span>, <span class="fl">168208</span>, <span class="fl">128480</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">32</span>,<span class="fl">32</span>,<span class="fl">40</span><span class="op">)</span>, rawvoxdims<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/natverse/elmr" class="external-link">elmr</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># get a manually traced neuron (just keep first and only entry in neuronlist)</span></span></span>
<span class="r-in"><span><span class="va">dl4</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/catmaid/man/read.neuron.catmaid.html" class="external-link">read.neurons.catmaid</a></span><span class="op">(</span><span class="st">'glomerulus DL4 right'</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="co"># map every node location to segmentation ids</span></span></span>
<span class="r-in"><span><span class="va">dl4.segs</span><span class="op">=</span><span class="fu">brainmaps_xyz2id</span><span class="op">(</span><span class="va">dl4</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># remove unmapped locations which get id 0</span></span></span>
<span class="r-in"><span><span class="va">dl4.segs</span><span class="op">=</span><span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">dl4.segs</span>, <span class="fl">0</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># read in corresponding skeletons</span></span></span>
<span class="r-in"><span><span class="va">dl4.skels</span><span class="op">=</span><span class="fu"><a href="read_segments.html">read_segments2</a></span><span class="op">(</span><span class="va">dl4.segs</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># read in corresponding skeletons after including agglomeration merge groups</span></span></span>
<span class="r-in"><span><span class="va">dl4.allskels</span><span class="op">=</span><span class="fu"><a href="read_segments.html">read_segments2</a></span><span class="op">(</span><span class="fu"><a href="find_merged_segments.html">find_merged_segments</a></span><span class="op">(</span><span class="va">dl4.segs</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## retries / cache / chunksize issues</span></span></span>
<span class="r-in"><span><span class="co"># set small chunk size</span></span></span>
<span class="r-in"><span><span class="va">dl4.segs</span><span class="op">=</span><span class="fu">brainmaps_xyz2id</span><span class="op">(</span><span class="va">dl4</span>, chunksize<span class="op">=</span><span class="fl">500</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># use retries in case of failure</span></span></span>
<span class="r-in"><span><span class="va">dl4.segs</span><span class="op">=</span><span class="fu">brainmaps_xyz2id</span><span class="op">(</span><span class="va">dl4</span>, chunksize<span class="op">=</span><span class="fl">500</span>, retry<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># cache successful requests (if you might need to repeat)</span></span></span>
<span class="r-in"><span><span class="va">dl4.segs</span><span class="op">=</span><span class="fu">brainmaps_xyz2id</span><span class="op">(</span><span class="va">dl4</span>, chunksize<span class="op">=</span><span class="fl">500</span>, retry<span class="op">=</span><span class="fl">3</span>, cache<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Gregory Jefferis.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer></div>





  </body></html>

