<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Query the FlyWire CAVE annotation system"><title>Query the FlyWire CAVE annotation system — flywire_cave_query • fafbseg</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Query the FlyWire CAVE annotation system — flywire_cave_query"><meta property="og:description" content="Query the FlyWire CAVE annotation system"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">fafbseg</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.13</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item">
  <a class="nav-link" href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/FAFB-FlyWire.html">FAFB-FlyWire</a>
    <a class="dropdown-item" href="../articles/accessing-graphene-server.html">Accessing the chunked graph server</a>
    <a class="dropdown-item" href="../articles/capturing-ngl-meshes.html">Capturing neuroglancer meshes from a browser scene</a>
    <a class="dropdown-item" href="../articles/installing-cloudvolume-meshparty.html">Installing python modules: cloudvolume, meshparty and skeletor</a>
    <a class="dropdown-item" href="../articles/mesh-to-mesh.html">Mesh to mesh distances</a>
    <a class="dropdown-item" href="../articles/fafbseg-catmaid-legacy-info.html">fafbseg-catmaid-legacy-info</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../SUPPORT.html">Help</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://natverse.org/">natverse</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/natverse/fafbseg">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Query the FlyWire CAVE annotation system</h1>
      <small class="dont-index">Source: <a href="https://github.com/natverse/fafbseg/blob/HEAD/R/cave.R" class="external-link"><code>R/cave.R</code></a></small>
      <div class="d-none name"><code>flywire_cave_query.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Query the FlyWire CAVE annotation system</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">flywire_cave_query</span><span class="op">(</span></span>
<span>  <span class="va">table</span>,</span>
<span>  datastack_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"fafbseg.cave.datastack_name"</span>, <span class="st">"flywire_fafb_production"</span><span class="op">)</span>,</span>
<span>  version <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  timestamp <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  live <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">version</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">timestamp</span><span class="op">)</span>,</span>
<span>  filter_in_dict <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  filter_out_dict <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>table</dt>
<dd><p>The name of the table (or view, see views section) to query</p></dd>


<dt>datastack_name</dt>
<dd><p>defaults to "flywire_fafb_production". See
<a href="https://global.daf-apis.com/info/" class="external-link">https://global.daf-apis.com/info/</a> for other options.</p></dd>


<dt>version</dt>
<dd><p>An optional CAVE materialisation version number. See details
and examples.</p></dd>


<dt>timestamp</dt>
<dd><p>An optional timestamp as a string or POSIXct, interpreted as
UTC when no timezone is specified.</p></dd>


<dt>live</dt>
<dd><p>Whether to use live query mode, which updates any root ids to
their current value.</p></dd>


<dt>filter_in_dict, filter_out_dict</dt>
<dd><p>Optional arguments consisting of key
value lists that restrict the returned rows (keeping only matches or
filtering out matches). Commonly used to selected rows for specific
neurons. See examples and CAVE documentation for details.</p></dd>


<dt>...</dt>
<dd><p>Additional arguments to the query method. See examples and
details.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>A <code>tibble</code>. Note that xyzmatrix can be used on single columns
  containing XYZ locations.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>CAVE (Connectome Annotation Versioning Engine) provides a shared
  infrastructure for a number of connectomics projects involving Sebastian
  Seung's group at Princeton and collaborators at the Allen Institute. There
  is both a backend system running on their servers and a Python client for
  end users.</p>
<p>You can find out more at <a href="https://caveclient.readthedocs.io/" class="external-link">https://caveclient.readthedocs.io/</a> as well
  as looking at the Python notebooks on the github repo
  <a href="https://github.com/seung-lab/CAVEclient" class="external-link">https://github.com/seung-lab/CAVEclient</a>.</p>
<p>The annotation system shares authentication infrastructure with the rest of
  the FlyWire API (see <code><a href="flywire_set_token.html">flywire_set_token</a></code>).</p>
    </div>
    <div class="section level2">
    <h2 id="cave-materialisation-versions-and-timestamps">CAVE Materialisation Versions and Timestamps<a class="anchor" aria-label="anchor" href="#cave-materialisation-versions-and-timestamps"></a></h2>
    <p>CAVE has a concept of
  table snapshots identified by an integer materialization <code>version</code>
  number. In some cases you may wish to query a table at this defined version
  number so that you can avoid root_ids changing during an analysis. Your
  calls will also be faster since no root id updates are required.</p>
<p>Note however that materialisation versions expire at which point the
  corresponding version of the database is expunged. However it is still
  possible to find the timestamp for an expired materialisation version.
  <code>flywire_cave_query</code> does this automatically using
  <code><a href="flywire_timestamp.html">flywire_timestamp</a></code>. In these circumstances queries will again
  be slower (quite possibly slower than the live query) since all root ids
  must be recalculated to match the timestamp.</p>
<p>CAVE's ability to handle different timepoints is key to analysis for a
  continually evolving segmentation but is frankly a little difficult for
  users to work with. You will find things simplest if you either</p><ul><li><p>use a long-term support (LTS) version, which will not expire such as
  the 630 version for the June 2023 public release.</p></li>
<li><p>use the latest CAVE version</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="cave-views">CAVE Views<a class="anchor" aria-label="anchor" href="#cave-views"></a></h2>
    <p>In addition to regular database tables, CAVE provides
  support for <b>views</b>. These are based on a SQL query which typically
  aggregates or combines multiple tables. For an example an aggregation might
  define the total number of output synapses for some selected neurons.</p>
<p>At present there are several restrictions on views. For example, you can
  only fetch views using an unexpired materialisation version (and you cannot
  specify a timepoint using a timestamp) . Furthermore some <code>filter_in,
  filter_out</code> queries using columns created by the SQL statement may not be
  possible.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="flywire_cave_client.html">flywire_cave_client</a></code></p>
<p>Other cave-queries: 
<code><a href="flywire_timestamp.html">flywire_timestamp</a>()</code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># \donttest{</span></span></span>
<span class="r-in"><span><span class="co"># note use of limit to restrict the number of rows (must be integer)</span></span></span>
<span class="r-in"><span><span class="va">n10</span><span class="op">=</span><span class="fu">flywire_cave_query</span><span class="op">(</span>table <span class="op">=</span> <span class="st">'nuclei_v1'</span>, limit<span class="op">=</span><span class="fl">10L</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">n10</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     id             created superceded_id valid     volume pt_supervoxel_id</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 2338 2021-06-23 19:56:18            NA     t  0.2616115                0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2 3078 2021-06-23 19:55:39            NA     t  4.1247949                0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3 3292 2021-06-23 19:56:19            NA     t  0.2737357                0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4 3502 2021-06-23 19:55:39            NA     t  6.7878502                0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5 4404 2021-06-23 19:55:51            NA     t  0.8473395                0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6 4446 2021-06-23 19:55:50            NA     t 58.8006195                0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   pt_root_id           pt_position     bb_start_position       bb_end_position</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1          0 95520, 254368, 218600 94528, 253184, 218520 96384, 255776, 218680</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2          0 97472, 252352, 218040 96128, 248992, 217640 98944, 254720, 218600</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3          0 97280, 250784, 219320 96544, 249408, 219240 98080, 251744, 219520</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4          0 98304, 253376, 216480 96928, 250752, 215240 99936, 256000, 217240</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5          0 81280, 295968, 186680 80640, 294496, 186320 82048, 297600, 187440</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6          0 84128, 291584, 193400 81504, 288000, 190240 87104, 295904, 196280</span>
<span class="r-in"><span><span class="co"># }</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="va">nuclei_v1</span><span class="op">=</span><span class="fu">flywire_cave_query</span><span class="op">(</span>table <span class="op">=</span> <span class="st">'nuclei_v1'</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">points3d</span><span class="op">(</span><span class="fu"><a href="xyzmatrix.html">xyzmatrix</a></span><span class="op">(</span><span class="va">nuclei_v1</span><span class="op">$</span><span class="va">pt_position</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/natverse/elmr" class="external-link">elmr</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># calculate signed distance to FAFB surface</span></span></span>
<span class="r-in"><span><span class="co"># NB this surface is not a perfect fit in the optic lobes</span></span></span>
<span class="r-in"><span><span class="va">nuclei_v1</span><span class="op">$</span><span class="va">d</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/nat/man/pointsinside.html" class="external-link">pointsinside</a></span><span class="op">(</span><span class="fu"><a href="xyzmatrix.html">xyzmatrix</a></span><span class="op">(</span><span class="va">nuclei_v1</span><span class="op">$</span><span class="va">pt_position</span><span class="op">)</span>, <span class="va">FAFB.surf</span>,</span></span>
<span class="r-in"><span>  rval <span class="op">=</span> <span class="st">'dist'</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">points3d</span><span class="op">(</span><span class="fu"><a href="xyzmatrix.html">xyzmatrix</a></span><span class="op">(</span><span class="va">nuclei_v1</span><span class="op">$</span><span class="va">pt_position</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  col<span class="op">=</span><span class="fu">matlab</span><span class="fu">::</span><span class="fu">jet.colors</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">nuclei_v1</span><span class="op">$</span><span class="va">d</span>,<span class="fl">20</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">plot3d</span><span class="op">(</span><span class="va">FAFB</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="co"># Example of a query on a table</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="co"># the Princeton (mostly) and Cambridge groups have tagged some bodies as</span></span></span>
<span class="r-in"><span><span class="co"># not a neuron - these are often glia.</span></span></span>
<span class="r-in"><span><span class="va">nans</span><span class="op">=</span><span class="fu">flywire_cave_query</span><span class="op">(</span><span class="st">'neuron_information_v2'</span>,</span></span>
<span class="r-in"><span>  filter_in_dict <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>tag<span class="op">=</span><span class="st">'not a neuron'</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">nans</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">nans</span><span class="op">$</span><span class="va">user_id</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="va">psp_351</span><span class="op">=</span><span class="fu">flywire_cave_query</span><span class="op">(</span>table <span class="op">=</span> <span class="st">'proofreading_status_public_v1'</span>,</span></span>
<span class="r-in"><span>  version<span class="op">=</span><span class="fl">351</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># get the last listed materialisation version</span></span></span>
<span class="r-in"><span><span class="va">fcc</span><span class="op">=</span><span class="fu"><a href="flywire_cave_client.html">flywire_cave_client</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">lastv</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">fcc</span><span class="op">$</span><span class="va">materialize</span><span class="op">$</span><span class="fu">get_versions</span><span class="op">(</span><span class="op">)</span>, n<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># pull that</span></span></span>
<span class="r-in"><span><span class="va">psp_last</span><span class="op">=</span><span class="fu">flywire_cave_query</span><span class="op">(</span>table <span class="op">=</span> <span class="st">'proofreading_status_public_v1'</span>,</span></span>
<span class="r-in"><span>  version<span class="op">=</span><span class="va">lastv</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Gregory Jefferis.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

